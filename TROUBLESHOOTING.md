# トラブルシューティングガイド

このドキュメントは、Shimesukun（シメスくん）アプリケーションの使用中に発生する可能性のある一般的な問題とその解決策をまとめたものです。

## 目次

1. [認証関連のエラー](#認証関連のエラー)
   - [ネットワークリクエストエラー](#ネットワークリクエストエラー)
   - [メールアドレスが既に使用されている](#メールアドレスが既に使用されている)
   - [ログイン失敗エラー](#ログイン失敗エラー)
   - [Firebase エミュレーター接続エラー](#firebase-エミュレーター接続エラー)
2. [Firebase エミュレーター関連の問題](#firebase-エミュレーター関連の問題)
   - [エラー: データベースルールが設定されていない](#エラー-データベースルールが設定されていない)
3. [Dify API 関連のトラブル](#dify-api-関連のトラブル)
   - [エラー: "Dify API キーが設定されていません"](#エラー-dify-api-キーが設定されていません)
   - [エラー: "AI 回答の生成に失敗しました"](#エラー-ai-回答の生成に失敗しました)
   - [エラー: "CORS policy" または "No 'Access-Control-Allow-Origin' header"](#エラー-cors-policy-または-no-access-control-allow-origin-header)
   - [回答品質に関する問題](#回答品質に関する問題)
   - [エラー: 必須パラメータが不足している](#エラー-必須パラメータが不足している)
   - [エラー: "HTML エラーページが返されました" または "Unexpected token '<'"](#エラー-htmlエラーページが返されました-または-unexpected-token)
4. [Dify ナレッジベース API 関連のトラブル](#dify-ナレッジベース-api-関連のトラブル)
   - [エラー: "Dify API キーが設定されていません"](#エラー-dify-api-キーが設定されていません-1)
   - [エラー: "ドキュメントのアップロードに失敗しました"](#エラー-ドキュメントのアップロードに失敗しました)
   - [エラー: "インデックス作成に失敗しました"](#エラー-インデックス作成に失敗しました)
   - [エラー: "ナレッジベースの作成に失敗しました"](#エラー-ナレッジベースの作成に失敗しました)
   - [ナレッジベースやドキュメントが表示されない](#ナレッジベースやドキュメントが表示されない)
5. [ナビゲーションと UI 関連のトラブル](#ナビゲーションとui関連のトラブル)
   - [モバイルメニューが開かない](#モバイルメニューが開かない)
   - [検索結果が表示されない](#検索結果が表示されない)

## 認証関連のエラー

### ネットワークリクエストエラー

**エラーメッセージ:**

```
FirebaseError: Firebase: Error (auth/network-request-failed)
```

**原因:**
このエラーは、Firebase の認証サービスとの通信中にネットワーク接続の問題が発生した場合に表示されます。主な原因は以下の通りです：

1. インターネット接続がない、または不安定
2. ファイアウォールやプロキシが Firebase 認証サービスへのアクセスをブロックしている
3. VPN 使用時の接続問題
4. Firebase サービスの一時的な障害

**解決策:**

1. **インターネット接続の確認:**

   - Wi-Fi またはモバイルデータのインターネット接続が有効であることを確認してください
   - 別のウェブサイトにアクセスできるか試してみてください

2. **ブラウザキャッシュと Cookie のクリア:**

   - ブラウザのキャッシュと Cookie をクリアして再試行してください

3. **VPN を使用している場合:**

   - VPN 接続を一時的に無効にして再試行してください
   - 別の VPN サーバーに接続してみてください

4. **別のブラウザで試す:**

   - 別のブラウザやデバイスからアクセスしてみてください

5. **ファイアウォールの設定確認:**

   - 組織のネットワークを使用している場合、ファイアウォールが Firebase ドメインをブロックしていないか確認してください

6. **後で再試行:**
   - 一時的な Firebase サービスの問題の場合は、数分後に再試行してください

### メールアドレスが既に使用されている

**エラーメッセージ:**

```
FirebaseError: Firebase: Error (auth/email-already-in-use)
```

**原因:**
登録しようとしているメールアドレスが既に別のアカウントに関連付けられています。

**解決策:**

1. **別のメールアドレスを使用:**

   - 異なるメールアドレスで新規登録してください

2. **パスワードリセット:**

   - 既存のアカウントのパスワードを忘れた場合は、ログイン画面からパスワードリセットを行ってください

3. **Google ログインを試す:**
   - 同じメールアドレスで Google アカウントがある場合は、「Google アカウントで登録」オプションを使用してください

### ログイン失敗エラー

**エラーメッセージ:**

```
FirebaseError: Firebase: Error (auth/invalid-credential)
FirebaseError: Firebase: Error (auth/user-not-found)
FirebaseError: Firebase: Error (auth/wrong-password)
FirebaseError: Firebase: Error (auth/too-many-requests)
```

**原因:**
ログイン処理中に認証情報の検証で問題が発生しました。主な原因は以下の通りです：

1. メールアドレスまたはパスワードが間違っている
2. 指定したメールアドレスのアカウントが存在しない
3. パスワードの入力ミス
4. 短時間に複数回ログインを試行して制限に達した

**解決策:**

1. **認証情報の確認:**

   - メールアドレスとパスワードが正確に入力されているか確認してください
   - メールアドレスの大文字・小文字は区別されないですが、パスワードは区別されます

2. **パスワードリセット:**

   - パスワードを忘れた場合は、「パスワードをお忘れですか？」リンクからリセットしてください

3. **アカウント存在の確認:**

   - そのメールアドレスで登録したことがあるかどうか確認してください
   - 別のメールアドレスで登録した可能性があるか確認してください

4. **制限時間後に再試行:**

   - 複数回ログインに失敗した場合は、数分待ってから再試行してください
   - 時間をおいても解決しない場合は、パスワードリセットを試してください

5. **ネットワーク接続の確認:**
   - 安定したインターネット接続があることを確認してください

### Firebase エミュレーター接続エラー

**エラーメッセージ:**

```
FirebaseError: Firebase: Error (auth/emulator-config-failed)
```

**原因:**
Firebase エミュレーターに接続する際の設定が正しくない場合に発生します。

**解決策:**

1. **エミュレーターの設定確認:**

   - Firebase エミュレーターが正しく起動していることを確認してください。
   - `firebase.json` ファイルでエミュレーターの設定が正しいか確認してください。

2. **接続 URL の確認:**

   - エミュレーターのホストとポートが正しいか確認してください。
   - デフォルトでは `localhost:9099` が使用されます。

3. **環境変数の設定:**

   - `.env.local` ファイルでエミュレーターの URL を設定してください。
   - 例: `FIREBASE_AUTH_EMULATOR_HOST=localhost:9099`

4. **ネットワークの確認:**

   - ローカルネットワークでエミュレーターにアクセスできることを確認してください。

5. **ブラウザのキャッシュクリア:**
   - ブラウザのキャッシュをクリアして再試行してください。

## Firebase エミュレーター関連の問題

### エラー: データベースルールが設定されていない

**エラーメッセージ:**

```
firebase.json:2:3: Expected 'rules' property.
Failed to load initial Database Emulator rules
```

**原因:**
Firebase エミュレーターのデータベース設定にルールファイルが指定されていない場合に発生します。

**解決策:**

1. **firebase.json の修正:**

   `firebase.json` ファイルに以下の設定を追加します：

   ```json
   {
     "database": {
       "rules": "database.rules.json"
     }
   }
   ```

2. **データベースルールファイルの作成:**

   プロジェクトルートに `database.rules.json` ファイルを作成し、以下の内容を記述します：

   ```json
   {
     "rules": {
       ".read": "auth != null",
       ".write": "auth != null"
     }
   }
   ```

3. **エミュレーターの再起動:**

   修正後、以下のコマンドでエミュレーターを再起動します：

   ```bash
   firebase emulators:start
   ```

これでエラーが解消されるはずです。

## Dify API 関連のトラブル

### エラー: "Dify API キーが設定されていません"

**原因**: 環境変数 `DIFY_API_KEY` が設定されていない。

**解決策**:

1. `.env.local` ファイルに `DIFY_API_KEY=あなたのDifyAPIキー` を追加する
2. サーバー側では `NEXT_PUBLIC_` プレフィックスのない環境変数を使用することを確認する
   - サーバーコンポーネント内では `process.env.DIFY_API_KEY` を使用
   - クライアントコンポーネント内では `process.env.NEXT_PUBLIC_DIFY_API_KEY` を使用
3. アプリケーションを再起動して環境変数を反映させる
4. Vercel にデプロイする場合は、プロジェクト設定の環境変数セクションでキーを追加する

**注意**:
サーバーサイドコンポーネント（"use server"）では、`NEXT_PUBLIC_` プレフィックスのない環境変数を使用する必要があります。一方、クライアントサイドコンポーネントでは環境変数名に `NEXT_PUBLIC_` プレフィックスが必要です。

### エラー: "AI 回答の生成に失敗しました"

**原因**:

- Dify API へのリクエストが失敗した
- API のレート制限に達した
- API キーが無効

**解決策**:

1. ブラウザのコンソールとサーバーログでエラー詳細を確認する
2. API キーが有効か確認する
3. Dify ダッシュボードでアプリケーションのステータスを確認する
4. リクエストの構造が正しいかコードを確認する

### エラー: "CORS policy" または "No 'Access-Control-Allow-Origin' header"

**原因**: Dify API の CORS 設定が制限されている。

**解決策**:

1. フロントエンドから直接 Dify API を呼び出すのではなく、必ず Next.js の API ルート経由で呼び出す
2. 自己ホスティングの Dify の場合は、CORS 設定を調整する

### 回答品質に関する問題

**原因**: Dify のアプリケーション設定やナレッジベースの問題。

**解決策**:

1. Dify ダッシュボードでプロンプトテンプレートを調整する
2. ナレッジベースにより多くの関連文書を追加する
3. Dify アプリケーションの設定で使用するモデル（GPT-4, Claude など）を変更する
4. 質問の前処理と回答の後処理ロジックを調整する

### エラー: 必須パラメータが不足している

**エラーメッセージ:**

```
Dify API エラー: question is required in input form
```

**原因:**
Dify API にリクエストを送信する際に、`query` パラメータが不足しているため発生します。

**解決策:**

1. **コード修正:**

   - `src/lib/dify.ts` ファイルで、リクエストペイロードに `query` パラメータを追加します。
   - 修正例:
     ```typescript
     const payload = {
       inputs: { question: question.trim() },
       query: question.trim(), // 必須パラメータとして追加
       response_mode: "streaming",
       conversation_id: conversationId,
       user: "user-001",
     };
     ```

2. **入力バリデーションの追加:**

   - 質問内容が空でないことを確認するバリデーションを追加します。
     ```typescript
     if (!question || question.trim() === "") {
       throw new Error("質問内容を入力してください。");
     }
     ```

3. **エラー処理の改善:**
   - API エラー時に詳細なエラーメッセージを表示するようにします。

これにより、Dify API が要求する必須パラメータが正しく送信され、エラーが解消されます。

### エラー: "HTML エラーページが返されました" または "Unexpected token '<'"

**エラーメッセージ:**

```
SyntaxError: Unexpected token '<'
```

**原因:**
Dify API のエンドポイントが正しく設定されていない、またはリクエストが失敗して HTML エラーページが返された場合に発生します。

**解決策:**

1. **API エンドポイントの確認:**

   - Dify API の URL が正しいか確認してください。
   - 例: `https://api.dify.ai/v1/endpoint`

2. **リクエストの構造確認:**

   - リクエストヘッダーやペイロードが正しいか確認してください。

3. **エラーレスポンスのログ確認:**

   - サーバーログでエラーレスポンスの内容を確認し、問題を特定してください。

4. **ネットワークの確認:**

   - ネットワーク接続が安定していることを確認してください。

5. **API のステータス確認:**
   - Dify ダッシュボードで API のステータスを確認し、サービスが稼働しているか確認してください。

これにより、HTML エラーページが返される問題を解消できます。

## Dify ナレッジベース API 関連のトラブル

### エラー: "Dify API キーが設定されていません"

**原因**:
環境変数 `DIFY_API_KEY` が設定されていない。

**解決策**:

1. `.env.local` ファイルに `DIFY_API_KEY=あなたのDifyAPIキー` を追加する
2. アプリケーションを再起動して環境変数を反映させる
3. Vercel にデプロイする場合は、プロジェクト設定の環境変数セクションでキーを追加する

### エラー: "ドキュメントのアップロードに失敗しました"

**原因**:

1. ファイルサイズが大きすぎる
2. サポートされていないファイル形式
3. ナレッジベースの設定に問題がある

**解決策**:

1. ファイルサイズを小さくする（Dify の制限を確認）
2. サポートされているファイル形式を使用する（PDF, TXT, DOCX, PPTX など）
3. Dify ダッシュボードでナレッジベースの設定を確認する

### エラー: "インデックス作成に失敗しました"

**原因**:

1. ドキュメント内容に問題がある
2. Dify のインデックスサービスに問題がある

**解決策**:

1. ドキュメントの内容を確認し、不正な文字やフォーマットを修正する
2. Dify のダッシュボードでエラーメッセージを確認する
3. しばらく待ってから再試行する

### エラー: "ナレッジベースの作成に失敗しました"

**原因**:

1. アカウントの作成上限に達している
2. 同名のナレッジベースが既に存在する
3. API キーの権限が不足している

**解決策**:

1. Dify ダッシュボードでアカウント制限を確認する
2. 異なる名前でナレッジベースを作成する
3. 適切な権限を持つ API キーを使用する

### ナレッジベースやドキュメントが表示されない

**原因**:

1. API 呼び出しに失敗している
2. 権限の問題

**解決策**:

1. ブラウザのコンソールでエラーを確認する
2. API キーの権限を確認する
3. ネットワークタブでリクエスト/レスポンスを確認する
4. サーバーログでエラーメッセージを確認する

## ナビゲーションと UI 関連のトラブル

### モバイルメニューが開かない

**原因**:
モバイルメニュートグルの JavaScript が正しく機能していない可能性があります。

**解決策**:

1. ブラウザのコンソールでエラーを確認する
2. `navbar.tsx` の実装を確認し、モバイルメニューの表示/非表示を適切に切り替える処理を実装する
3. モバイルメニューのボタンクリックイベントのリスナーを確認する

### 検索結果が表示されない

**原因**:

1. 検索クエリが空
2. 選択したナレッジベースにドキュメントがない
3. 検索結果が 0 件

**解決策**:

1. 検索クエリが入力されているか確認する
2. ブラウザのコンソールでエラーがないか確認する
3. ナレッジベースにドキュメントが追加されているか確認する
4. ネットワークタブで API リクエスト/レスポンスを確認する
5. 別の検索キーワードや検索方法を試す
