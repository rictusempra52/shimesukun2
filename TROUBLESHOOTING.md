# トラブルシューティングガイド

このドキュメントは、Shimesukun（シメスくん）アプリケーションの使用中に発生する可能性のある一般的な問題とその解決策をまとめたものです。

## 目次

1. [認証関連のエラー](#認証関連のエラー)
   - [ネットワークリクエストエラー](#ネットワークリクエストエラー)
   - [メールアドレスが既に使用されている](#メールアドレスが既に使用されている)
2. [Dify API 関連のトラブル](#dify-api-関連のトラブル)
   - [エラー: "Dify API キーが設定されていません"](#エラー-dify-api-キーが設定されていません)
   - [エラー: "AI 回答の生成に失敗しました"](#エラー-ai-回答の生成に失敗しました)
   - [エラー: "CORS policy" または "No 'Access-Control-Allow-Origin' header"](#エラー-cors-policy-または-no-access-control-allow-origin-header)
   - [回答品質に関する問題](#回答品質に関する問題)

## 認証関連のエラー

### ネットワークリクエストエラー

**エラーメッセージ:**

```
FirebaseError: Firebase: Error (auth/network-request-failed)
```

**原因:**
このエラーは、Firebase の認証サービスとの通信中にネットワーク接続の問題が発生した場合に表示されます。主な原因は以下の通りです：

1. インターネット接続がない、または不安定
2. ファイアウォールやプロキシが Firebase 認証サービスへのアクセスをブロックしている
3. VPN 使用時の接続問題
4. Firebase サービスの一時的な障害

**解決策:**

1. **インターネット接続の確認:**

   - Wi-Fi またはモバイルデータのインターネット接続が有効であることを確認してください
   - 別のウェブサイトにアクセスできるか試してみてください

2. **ブラウザキャッシュと Cookie のクリア:**

   - ブラウザのキャッシュと Cookie をクリアして再試行してください

3. **VPN を使用している場合:**

   - VPN 接続を一時的に無効にして再試行してください
   - 別の VPN サーバーに接続してみてください

4. **別のブラウザで試す:**

   - 別のブラウザやデバイスからアクセスしてみてください

5. **ファイアウォールの設定確認:**

   - 組織のネットワークを使用している場合、ファイアウォールが Firebase ドメインをブロックしていないか確認してください

6. **後で再試行:**
   - 一時的な Firebase サービスの問題の場合は、数分後に再試行してください

### メールアドレスが既に使用されている

**エラーメッセージ:**

```
FirebaseError: Firebase: Error (auth/email-already-in-use)
```

**原因:**
登録しようとしているメールアドレスが既に別のアカウントに関連付けられています。

**解決策:**

1. **別のメールアドレスを使用:**

   - 異なるメールアドレスで新規登録してください

2. **パスワードリセット:**

   - 既存のアカウントのパスワードを忘れた場合は、ログイン画面からパスワードリセットを行ってください

3. **Google ログインを試す:**
   - 同じメールアドレスで Google アカウントがある場合は、「Google アカウントで登録」オプションを使用してください

## Dify API 関連のトラブル

### エラー: "Dify API キーが設定されていません"

**原因**: 環境変数 `DIFY_API_KEY` が設定されていない。

**解決策**:

1. `.env.local` ファイルに `DIFY_API_KEY=あなたのDifyAPIキー` を追加する
2. Vercel にデプロイする場合は、プロジェクト設定の環境変数セクションでキーを追加する
3. サーバーを再起動して環境変数を反映させる

### エラー: "AI 回答の生成に失敗しました"

**原因**:

- Dify API へのリクエストが失敗した
- API のレート制限に達した
- API キーが無効

**解決策**:

1. ブラウザのコンソールとサーバーログでエラー詳細を確認する
2. API キーが有効か確認する
3. Dify ダッシュボードでアプリケーションのステータスを確認する
4. リクエストの構造が正しいかコードを確認する

### エラー: "CORS policy" または "No 'Access-Control-Allow-Origin' header"

**原因**: Dify API の CORS 設定が制限されている。

**解決策**:

1. フロントエンドから直接 Dify API を呼び出すのではなく、必ず Next.js の API ルート経由で呼び出す
2. 自己ホスティングの Dify の場合は、CORS 設定を調整する

### 回答品質に関する問題

**原因**: Dify のアプリケーション設定やナレッジベースの問題。

**解決策**:

1. Dify ダッシュボードでプロンプトテンプレートを調整する
2. ナレッジベースにより多くの関連文書を追加する
3. Dify アプリケーションの設定で使用するモデル（GPT-4, Claude など）を変更する
4. 質問の前処理と回答の後処理ロジックを調整する
